# ğŸ¯ Flujo de Datos Multicast - StreamHub

## ğŸ“Š Diagrama de Arquitectura Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STREAMER CLIENT (Browser)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Camera     â”‚  â”‚  Microphone  â”‚  â”‚   Canvas     â”‚          â”‚
â”‚  â”‚  getUserMediaâ”‚  â”‚ getUserMedia â”‚  â”‚   Capture    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                           â”‚                                     â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                  â”‚  Compress to    â”‚                            â”‚
â”‚                  â”‚  JPEG/Base64    â”‚                            â”‚
â”‚                  â”‚  Quality: 70%   â”‚                            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                           â”‚                                     â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚ socket.emit(        â”‚                        â”‚
â”‚                  â”‚  'stream:data:send',â”‚                        â”‚
â”‚                  â”‚  { streamKey, data }â”‚                        â”‚
â”‚                  â”‚ )                   â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Socket.IO
                            â”‚ (~2.5 Mbps CONSTANTE)
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVER HUB (Node.js)                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              1. EVENT HANDLER                            â”‚   â”‚
â”‚  â”‚  socket.on('stream:data:send', (data) => {               â”‚   â”‚
â”‚  â”‚    // Validar streamer                                   â”‚   â”‚
â”‚  â”‚    streamDistributor.distributeStreamData(...)           â”‚   â”‚
â”‚  â”‚  })                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         2. STREAM DISTRIBUTOR (Multicast Core)           â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  activeStreams: Map<streamKey, Set<viewerSocketIds>>     â”‚   â”‚
â”‚  â”‚  streamBuffers: Map<streamKey, Frame[]> (Ãºltimos 30)     â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  distributeStreamData(streamKey, data, streamerId) {     â”‚   â”‚
â”‚  â”‚    const viewers = this.activeStreams.get(streamKey);    â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚    // 1. Guardar en buffer circular                      â”‚   â”‚
â”‚  â”‚    this.addToBuffer(streamKey, data);                    â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚    // 2. MULTICAST a TODOS los viewers                   â”‚   â”‚
â”‚  â”‚    io.to(`stream:${streamKey}`).emit('stream:data', data)â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚    return viewers.size; // Viewers alcanzados            â”‚   â”‚
â”‚  â”‚  }                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚  Socket.IO Room Broadcastâ”‚                       â”‚
â”‚              â”‚  (Optimizado para Multicast)                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                      â”‚
                â”‚ Broadcast simultÃ¡neo â”‚
                â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚  Viewer Socket 1 â”‚  â”‚  Viewer Socket 2 â”‚  â”‚  Viewer Socket Nâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  VIEWER 1 (Browser)  â”‚ â”‚  VIEWER 2 (Browser)â”‚ â”‚ VIEWER N (Browser)â”‚
â”‚                      â”‚ â”‚                    â”‚ â”‚                   â”‚
â”‚ socket.on('stream:   â”‚ â”‚ socket.on('stream: â”‚ â”‚ socket.on('stream:â”‚
â”‚   data', (data) => { â”‚ â”‚   data', (data) => {â”‚ â”‚  data', (data) => {â”‚
â”‚   displayFrame(data) â”‚ â”‚   displayFrame(data)â”‚ â”‚  displayFrame(data)â”‚
â”‚ })                   â”‚ â”‚ })                  â”‚ â”‚ })                â”‚
â”‚                      â”‚ â”‚                     â”‚ â”‚                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚  <img> Element   â”‚ â”‚ â”‚ â”‚  <img> Element   â”‚â”‚ â”‚â”‚ <img> Element   â”‚â”‚
â”‚ â”‚  src = base64    â”‚ â”‚ â”‚ â”‚  src = base64    â”‚â”‚ â”‚â”‚ src = base64    â”‚â”‚
â”‚ â”‚  ~30 FPS         â”‚ â”‚ â”‚ â”‚  ~30 FPS         â”‚â”‚ â”‚â”‚ ~30 FPS         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo de Eventos Paso a Paso

### 1ï¸âƒ£ CreaciÃ³n de Stream

```
Streamer                   Server                    Database/Memory
   â”‚                          â”‚                            â”‚
   â”œâ”€â”€registerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                            â”‚
   â”‚                          â”œâ”€â”€UserFactory.create()â”€â”€â†’   â”‚
   â”‚                          â”‚                            â”‚
   â”œâ”€â”€stream:createâ”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                            â”‚
   â”‚                          â”œâ”€â”€StreamFactory.create()â”€â”€â†’ â”‚
   â”‚                          â”œâ”€â”€StreamDistributor.â”€â”€â”€â”€â†’   â”‚
   â”‚                          â”‚  registerStream()          â”‚
   â”‚                          â”‚                            â”‚
   â”‚â†â”€â”€stream:createdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ {streamKey: 'abc123'}      â”‚
   â”‚  {streamKey}             â”‚                            â”‚
```

### 2ï¸âƒ£ Viewer se Une

```
Viewer 1                   Server                  StreamDistributor
   â”‚                          â”‚                            â”‚
   â”œâ”€â”€stream:joinâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                            â”‚
   â”‚  {streamKey}             â”‚                            â”‚
   â”‚                          â”œâ”€â”€addViewer()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
   â”‚                          â”‚                            â”œâ”€ Set<viewers>
   â”‚                          â”‚                            â”‚  .add(viewer1)
   â”‚                          â”‚                            â”‚
   â”‚                          â”‚â†â”€â”€sendBuffer()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚â†â”€â”€stream:bufferâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ [frame1, frame2, ..., frame30]
   â”‚  (Ãºltimos 30 frames)     â”‚                            â”‚
   â”‚                          â”‚                            â”‚
   â”‚â†â”€â”€stream:joinedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
```

### 3ï¸âƒ£ Streaming Multicast (Loop continuo)

```
Streamer              Server              StreamDistributor        Viewers (1â†’N)
   â”‚                    â”‚                        â”‚                      â”‚
   â”œâ”€capture frameâ”€â”€â†’   â”‚                        â”‚                      â”‚
   â”œâ”€compress JPEGâ”€â”€â†’   â”‚                        â”‚                      â”‚
   â”‚                    â”‚                        â”‚                      â”‚
   â”œâ”€stream:data:sendâ”€â†’ â”‚                        â”‚                      â”‚
   â”‚  {data: base64}    â”‚                        â”‚                      â”‚
   â”‚                    â”œâ”€validate streamerâ”€â†’    â”‚                      â”‚
   â”‚                    â”‚                        â”‚                      â”‚
   â”‚                    â”œâ”€distributeStreamDataâ”€â†’ â”‚                      â”‚
   â”‚                    â”‚                        â”œâ”€addToBuffer()        â”‚
   â”‚                    â”‚                        â”‚  [keep last 30]      â”‚
   â”‚                    â”‚                        â”‚                      â”‚
   â”‚                    â”‚                        â”œâ”€io.to('stream:key') â”€â”¤
   â”‚                    â”‚                        â”‚  .emit('stream:data')â”‚
   â”‚                    â”‚                        â”‚                      â”‚
   â”‚                    â”‚                        â”‚  â”Œâ”€â”€â”€MULTICASTâ”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                    â”‚                        â”‚  â”‚                   â”‚
   â”‚                    â”‚                        â”‚  â”œâ”€â”€â†’ Viewer 1       â”‚
   â”‚                    â”‚                        â”‚  â”œâ”€â”€â†’ Viewer 2       â”‚
   â”‚                    â”‚                        â”‚  â”œâ”€â”€â†’ Viewer 3       â”‚
   â”‚                    â”‚                        â”‚  â””â”€â”€â†’ Viewer N       â”‚
   â”‚                    â”‚                        â”‚                      â”‚
   â”‚â†â”€(opcional)â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚                      â”‚
   â”‚  confirm sent      â”‚                        â”‚                      â”‚
   â”‚                    â”‚                        â”‚                      â”‚
   â”‚                                                                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOOP (30 veces/segundo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

### 4ï¸âƒ£ Viewer TardÃ­o (Late Joiner)

```
Viewer 2 (new)         Server              StreamDistributor
   â”‚                    â”‚                        â”‚
   â”œâ”€stream:joinâ”€â”€â”€â”€â”€â”€â”€â†’â”‚                        â”‚
   â”‚                    â”œâ”€addViewer()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                    â”‚                        â”œâ”€viewers.add(viewer2)
   â”‚                    â”‚                        â”‚
   â”‚                    â”‚â†â”€sendBufferToViewer()â”€â”€â”¤
   â”‚â—„â”€stream:bufferâ”€â”€â”€â”€â”€â”¤ [Ãºltimos 30 frames]    â”‚
   â”‚  (catchup)         â”‚                        â”‚
   â”‚                    â”‚                        â”‚
   â”‚â—„â”€stream:dataâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  (frames nuevos)   â”‚  (multicast continuo)  â”‚
   â”‚                    â”‚                        â”‚
```

### 5ï¸âƒ£ FinalizaciÃ³n de Stream

```
Streamer              Server              StreamDistributor     Viewers
   â”‚                    â”‚                        â”‚                 â”‚
   â”œâ”€stream:endâ”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                        â”‚                 â”‚
   â”‚  {streamKey}       â”‚                        â”‚                 â”‚
   â”‚                    â”œâ”€endStream()â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚                 â”‚
   â”‚                    â”‚                        â”œâ”€unregister()    â”‚
   â”‚                    â”‚                        â”‚  - clear viewersâ”‚
   â”‚                    â”‚                        â”‚  - clear buffer â”‚
   â”‚                    â”‚                        â”‚                 â”‚
   â”‚                    â”œâ”€broadcastâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                    â”‚  'stream:ended'        â”‚                 â”‚
   â”‚                    â”‚                        â”‚                 â”‚
   â”‚                    â”œâ”€socketsLeave()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                    â”‚  (vaciar room)         â”‚                 â”‚
```

---

## ğŸ“Š ComparaciÃ³n de Ancho de Banda

### Escenario: 50 viewers viendo un stream

#### âŒ WebRTC P2P (Anterior)

```
Streamer Upload:
  Viewer 1:  2.5 Mbps
  Viewer 2:  2.5 Mbps
  Viewer 3:  2.5 Mbps
  ...
  Viewer 50: 2.5 Mbps
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL:   125 Mbps âŒ (IMPOSIBLE con conexiÃ³n residencial)
```

#### âœ… Multicast (Actual)

```
Streamer Upload:
  â†’ Server:  2.5 Mbps
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL:     2.5 Mbps âœ…

Server Downstream:
  â†’ Viewer 1:  2.5 Mbps
  â†’ Viewer 2:  2.5 Mbps
  â†’ Viewer 3:  2.5 Mbps
  ...
  â†’ Viewer 50: 2.5 Mbps
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL:     125 Mbps (distribuido por el servidor)
```

**Ventaja**: El streamer SIEMPRE usa solo 2.5 Mbps ğŸ‰

---

## ğŸ¯ Optimizaciones Implementadas

### 1. Socket.IO Rooms
- Usa broadcasting eficiente
- O(1) para enviar a N viewers
- No loops manuales

### 2. Buffer Circular
- Solo Ãºltimos 30 frames en memoria
- FIFO automÃ¡tico
- ~1.5 MB de RAM por stream

### 3. Lazy Cleanup
- Solo limpia cada hora
- No bloquea operaciones principales
- Garbage collection automÃ¡tico

### 4. Conditional Logging
- Solo loguea ~1% de frames
- No satura la consola
- Mantiene debugging posible

---

**Implementado**: 31 de octubre de 2025  
**Arquitectura**: Multicast con Socket.IO  
**Estado**: âœ… ProducciÃ³n Ready
