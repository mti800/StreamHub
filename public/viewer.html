<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamHub - Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Creepster', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #2d0052 50%, #4a0080 100%);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 140, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(148, 0, 211, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #1a0033 0%, #2d0052 50%, #4a0080 100%);
            min-height: 100vh;
            padding: 10px;
            position: relative;
            overflow-x: hidden;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }

        body::before {
            content: 'üéÉüëªü¶áüíÄüï∑Ô∏è';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            font-size: 40px;
            opacity: 0.1;
            z-index: 0;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        @media (min-width: 1400px) {
            .container {
                max-width: 1600px;
            }
        }

        @media (min-width: 1800px) {
            .container {
                max-width: 1920px;
            }
        }

        .header {
            text-align: center;
            color: #ff8c00;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff8c00, 0 0 20px #ff6b00, 0 0 30px #ff4500;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 900;
            letter-spacing: 3px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @media (min-width: 768px) {
            .header {
                margin-bottom: 30px;
            }
            
            .header h1 {
                font-size: 4.5em;
                letter-spacing: 5px;
            }
        }

        @media (min-width: 1400px) {
            .header h1 {
                font-size: 5.5em;
            }
        }

        .header h1::before {
            content: 'üéÉ ';
        }

        .header h1::after {
            content: ' üéÉ';
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 10px #ff8c00, 0 0 20px #ff6b00, 0 0 30px #ff4500, 0 0 40px #ff4500;
            }
            to {
                text-shadow: 0 0 20px #ff8c00, 0 0 30px #ff6b00, 0 0 40px #ff4500, 0 0 50px #ff4500, 0 0 60px #ff4500;
            }
        }

        .header p {
            color: #ffa500;
            font-size: 1.2em;
            text-shadow: 0 0 5px #ff8c00;
        }

        .card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #ff8c00;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.3), 0 0 50px rgba(148, 0, 211, 0.2);
            margin-bottom: 15px;
            position: relative;
        }

        @media (min-width: 768px) {
            .card {
                padding: 30px;
                margin-bottom: 20px;
            }
        }

        .card::before {
            content: 'üï∏Ô∏è';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 60px;
            opacity: 0.3;
        }

        .card h2, .card h3 {
            color: #ff8c00;
            text-shadow: 0 0 10px #ff8c00;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 1024px) {
            .main-content {
                flex-direction: row;
            }
        }

        .video-section {
            flex: 1;
            min-width: 0;
        }

        .chat-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        @media (min-width: 1024px) {
            .chat-section {
                width: 350px;
            }
        }

        @media (min-width: 1400px) {
            .chat-section {
                width: 450px;
            }
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            aspect-ratio: 16 / 9;
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: 2px solid #ff8c00;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.3);
        }

        @media (min-width: 768px) {
            button {
                padding: 12px 24px;
                font-size: 16px;
            }
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 140, 0, 0.5), 0 0 20px rgba(255, 140, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);
            color: #1a0033;
            font-weight: 700;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #ff1744 0%, #dc143c 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #4b0082 0%, #2e0054 100%);
            color: #ffa500;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #5d0099 0%, #4b0082 100%);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            background: rgba(25, 0, 51, 0.8);
            border: 2px solid #9370db;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(147, 112, 219, 0.3);
        }

        .input-group {
            margin-bottom: 15px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff8c00;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(25, 0, 51, 0.8);
            color: #ffa500;
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);
        }

        input:focus {
            outline: none;
            border-color: #ffa500;
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.5);
        }

        input::placeholder {
            color: #9370db;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            background: rgba(10, 0, 20, 0.8);
            border: 2px solid #9370db;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            min-height: 300px;
            max-height: 500px;
            box-shadow: inset 0 0 20px rgba(148, 0, 211, 0.2);
        }

        @media (min-width: 768px) {
            .chat-container {
                padding: 15px;
                min-height: 400px;
            }
        }

        @media (min-width: 1024px) {
            .chat-container {
                min-height: 500px;
                max-height: 600px;
            }
        }

        @media (min-width: 1400px) {
            .chat-container {
                min-height: 600px;
                max-height: 700px;
            }
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(75, 0, 130, 0.3);
            border-left: 3px solid #ff8c00;
            border-radius: 5px;
            color: #ffa500;
        }

        .chat-message strong {
            color: #ff8c00;
            text-shadow: 0 0 5px #ff8c00;
        }

        .chat-message.system {
            background: rgba(148, 0, 211, 0.3);
            border-left-color: #9370db;
            color: #da70d6;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input-container input {
            flex: 1;
        }

        .reactions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .reactions {
                gap: 10px;
                justify-content: flex-start;
            }
        }

        @media (min-width: 1024px) {
            .reactions {
                margin-bottom: 20px;
            }
        }

        .reaction-btn {
            padding: 8px 16px;
            font-size: 20px;
            background: linear-gradient(135deg, #4b0082 0%, #2e0054 100%);
            border: 2px solid #ff8c00;
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.3);
        }

        @media (min-width: 768px) {
            .reaction-btn {
                padding: 10px 20px;
                font-size: 24px;
            }
        }

        .reaction-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.6);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
        }

        @media (min-width: 1400px) {
            .stats {
                gap: 30px;
            }
        }

        .stat-item {
            background: linear-gradient(135deg, #4b0082 0%, #8b008b 100%);
            border: 2px solid #ff8c00;
            color: #ffa500;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.3);
        }

        @media (min-width: 768px) {
            .stat-item {
                padding: 10px 20px;
            }
        }

        .stat-item .number {
            font-size: 20px;
            font-weight: bold;
            color: #ff8c00;
            text-shadow: 0 0 10px #ff8c00;
        }

        @media (min-width: 768px) {
            .stat-item .number {
                font-size: 24px;
            }
        }

        @media (min-width: 1400px) {
            .stat-item .number {
                font-size: 28px;
            }
        }

        .stat-item .label {
            font-size: 11px;
            opacity: 0.9;
            color: #ffa500;
        }

        @media (min-width: 768px) {
            .stat-item .label {
                font-size: 12px;
            }
        }

        @media (min-width: 1400px) {
            .stat-item .label {
                font-size: 14px;
            }
        }

        .hidden {
            display: none;
        }

        .live-indicator {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
            border: 2px solid #ff8c00;
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
            }
            50% { 
                opacity: 0.7;
                box-shadow: 0 0 30px rgba(255, 140, 0, 0.8);
            }
        }

        .user-item {
            background: rgba(75, 0, 130, 0.4);
            border: 2px solid #9370db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .user-item:hover {
            border-color: #ff8c00;
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.3);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            color: #ffa500;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-status {
            color: #9370db;
            font-size: 14px;
        }

        .user-status.streaming {
            color: #dc143c;
            font-weight: bold;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn-subscribe {
            background: linear-gradient(135deg, #4b0082 0%, #2e0054 100%);
            color: #ffa500;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-subscribe.subscribed {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);
            color: #1a0033;
        }

        .btn-join-stream {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .stream-card {
            background: linear-gradient(135deg, #4b0082 0%, #2e0054 100%);
            border: 2px solid #dc143c;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stream-card:hover {
            border-color: #ff8c00;
            box-shadow: 0 5px 20px rgba(255, 140, 0, 0.4);
            transform: translateY(-3px);
        }

        .stream-card h4 {
            color: #ff8c00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #4b0082 0%, #2e0054 100%);
            border: 3px solid #ff8c00;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.5);
            z-index: 9999;
            animation: slideIn 0.5s ease-out;
            max-width: 90vw;
        }

        @media (min-width: 768px) {
            .notification {
                top: 20px;
                right: 20px;
                padding: 20px;
                max-width: 350px;
            }
        }

        @media (min-width: 1400px) {
            .notification {
                max-width: 450px;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification h4 {
            color: #ff8c00;
            margin-bottom: 10px;
        }

        .notification p {
            color: #ffa500;
            margin-bottom: 15px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
        }

        /* Buffering Overlay */
        .buffering-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .buffering-overlay.hidden {
            display: none;
        }

        .buffering-spinner {
            border: 4px solid rgba(255, 140, 0, 0.3);
            border-top: 4px solid #ff8c00;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .buffering-overlay p {
            color: #ffa500;
            font-size: 18px;
            font-weight: bold;
        }

        /* Connection Warning */
        .connection-warning {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 20, 60, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #ff8c00;
            z-index: 5;
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
            animation: pulse 2s infinite;
        }

        .connection-warning.hidden {
            display: none;
        }

        .connection-warning p {
            margin: 0;
            font-weight: bold;
            font-size: 14px;
        }

        /* Quality Indicators */
        #connectionQuality .number {
            font-size: 32px;
        }

        .quality-excellent { color: #00ff00 !important; }
        .quality-good { color: #ffff00 !important; }
        .quality-fair { color: #ffa500 !important; }
        .quality-poor { color: #ff0000 !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>STREAMHUB</h1>
            <p>üëª Mira streams de terror en vivo y chatea ü¶á</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="card">
            <h2>Iniciar Sesi√≥n</h2>
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="Tu nombre de usuario" />
            </div>
            <button class="btn-primary" onclick="login()">Conectar</button>
            <button class="btn-secondary" onclick="clearSavedUser()" style="margin-top: 10px; background: rgba(255, 0, 0, 0.2); border-color: #ff6b6b;">
                Cambiar Usuario
            </button>
        </div>

        <!-- Join Stream Section -->
        <div id="joinSection" class="card hidden">
            <h2>Dashboard de Viewer</h2>
            
            <!-- Streams activos de usuarios suscritos -->
            <div class="info-box">
                <h3>üé¨ Streams Activos de tus Suscripciones</h3>
                <div id="subscribedStreams" style="margin-top: 15px;">
                    <p style="color: #9370db;">No hay streams activos de usuarios a los que est√°s suscrito</p>
                </div>
            </div>

            <!-- Unirse manualmente a un stream -->
            <div style="margin-top: 20px;">
                <h3>O √∫nete manualmente con Stream Key:</h3>
                <div class="input-group">
                    <input type="text" id="streamKeyInput" placeholder="Ingresa la Stream Key" />
                </div>
                <button class="btn-primary" onclick="joinStream()">Unirse</button>
            </div>

            <!-- Lista de todos los usuarios -->
            <div style="margin-top: 30px;">
                <h3>üë• Todos los Usuarios</h3>
                <div id="usersList" style="margin-top: 15px;">
                    <p style="color: #9370db;">Cargando usuarios...</p>
                </div>
            </div>
        </div>

        <!-- Stream Viewing Section -->
        <div id="viewSection" class="card hidden">
            <div class="info-box">
                <span class="live-indicator">üî¥ EN VIVO</span>
                <div class="stats">
                    <div class="stat-item">
                        <div class="number" id="viewerCount">0</div>
                        <div class="label">Viewers</div>
                    </div>
                    <div class="stat-item" id="connectionQuality">
                        <div class="number">üü¢</div>
                        <div class="label">Conexi√≥n</div>
                    </div>
                    <div class="stat-item">
                        <div class="number" id="packetLoss">0%</div>
                        <div class="label">P√©rdida</div>
                    </div>
                    <div class="stat-item">
                        <div class="number" id="latency">0ms</div>
                        <div class="label">Latencia</div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="video-section">
                    <div class="video-container">
                        <video id="remoteVideo" autoplay playsinline controls muted></video>
                        <div id="bufferingOverlay" class="buffering-overlay hidden">
                            <div class="buffering-spinner"></div>
                            <p>Buffering...</p>
                        </div>
                        <div id="poorConnectionWarning" class="connection-warning hidden">
                            <p>‚ö†Ô∏è Conexi√≥n inestable. Puede haber interrupciones.</p>
                        </div>
                    </div>

                    <h3>Reacciones R√°pidas</h3>
                    <div class="reactions">
                        <button class="reaction-btn" onclick="sendReaction('üëç')">üëç</button>
                        <button class="reaction-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                        <button class="reaction-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
                        <button class="reaction-btn" onclick="sendReaction('üî•')">üî•</button>
                        <button class="reaction-btn" onclick="sendReaction('üéâ')">üéâ</button>
                    </div>
                </div>

                <div class="chat-section">
                    <h3>üí¨ Chat en Vivo</h3>
                    <div class="chat-container" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Escribe un mensaje..." />
                        <button class="btn-primary" onclick="sendMessage()">Enviar</button>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-danger" onclick="leaveStream()">Salir del Stream</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let peerConnection;
        let streamKey = null;
        let userId = null;
        let currentUser = null;
        let allUsers = [];
        let subscribedStreams = [];

        // Variables para monitoreo de red y buffering adaptativo
        let statsInterval = null;
        let lastPacketsLost = 0;
        let lastPacketsReceived = 0;
        let consecutivePoorQuality = 0;
        let bufferingActive = false;
        let tabId = null; // ID √∫nico de esta pesta√±a

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Generar ID √∫nico para esta pesta√±a
        window.addEventListener('DOMContentLoaded', () => {
            // Cada pesta√±a tiene su propio sessionStorage
            tabId = sessionStorage.getItem('streamhub_tab_id');
            
            if (!tabId) {
                // Nueva pesta√±a - generar ID √∫nico
                tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('streamhub_tab_id', tabId);
            }

            // Intentar recuperar usuario de ESTA pesta√±a
            const savedUsername = sessionStorage.getItem('streamhub_username');
            const savedRole = sessionStorage.getItem('streamhub_role');
            
            if (savedUsername) {
                document.getElementById('usernameInput').value = savedUsername;
                console.log(`[Tab ${tabId}] Usuario recuperado: ${savedUsername}`);
                
                // Auto-login si viene de la p√°gina principal con rol viewer
                if (savedRole === 'viewer') {
                    console.log(`[Tab ${tabId}] Auto-login desde p√°gina principal`);
                    // Limpiar el rol para evitar auto-login en recargas
                    sessionStorage.removeItem('streamhub_role');
                    // Hacer login autom√°tico
                    setTimeout(() => login(), 100);
                } else {
                    document.getElementById('usernameInput').placeholder = `Usuario de esta pesta√±a: ${savedUsername}`;
                }
            } else {
                console.log(`[Tab ${tabId}] Nueva pesta√±a sin usuario`);
            }
        });

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Por favor ingresa un nombre de usuario');
                return;
            }

            // Guardar username en sessionStorage (solo esta pesta√±a)
            sessionStorage.setItem('streamhub_username', username);
            console.log(`[Tab ${tabId}] Usuario guardado en esta pesta√±a: ${username}`);

            socket = io('http://localhost:3000');

            socket.on('connect', () => {
                console.log('Conectado al servidor');
                socket.emit('user:register', { username, role: 'VIEWER' });
            });

            socket.on('user:registered', (data) => {
                userId = data.user.id;
                currentUser = data.user;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('joinSection').classList.remove('hidden');
                
                // Cargar lista de usuarios y suscripciones
                loadUsersList();
                loadSubscribedStreams();
            });

            socket.on('stream:joined', async (data) => {
                streamKey = data.stream.streamKey;
                document.getElementById('joinSection').classList.add('hidden');
                document.getElementById('viewSection').classList.remove('hidden');
                document.getElementById('viewerCount').textContent = data.stream.viewerCount;
                
                // Solicitar conexi√≥n WebRTC
                socket.emit('webrtc:request', { streamKey, viewerId: userId, socketId: socket.id });
            });

            socket.on('viewer:count:update', (data) => {
                document.getElementById('viewerCount').textContent = data.viewerCount;
            });

            socket.on('chat:message:broadcast', (data) => {
                addChatMessage(data.message);
            });

            socket.on('reaction:broadcast', (data) => {
                showReaction(data.reaction);
            });

            socket.on('webrtc:offer', async (data) => {
                await handleOffer(data);
            });

            socket.on('webrtc:ice-candidate', async (data) => {
                if (peerConnection && data.data) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.data));
                }
            });

            socket.on('stream:ended', () => {
                stopNetworkMonitoring();
                alert('El stream ha finalizado');
                location.reload();
            });

            // Eventos de suscripciones
            socket.on('user:subscribed', (data) => {
                console.log('Suscrito a:', data.targetUsername);
                loadUsersList();
            });

            socket.on('user:unsubscribed', (data) => {
                console.log('Desuscrito de:', data.targetUsername);
                loadUsersList();
            });

            socket.on('users:list', (data) => {
                allUsers = data.users;
                console.log(`[Users List] Recibidos ${data.users.length} usuarios`);
                
                // Renderizar lista de usuarios
                renderUsersList();
                
                // Actualizar streams activos de suscripciones
                updateSubscribedStreams();
            });

            socket.on('subscriptions:list', (data) => {
                console.log('Suscripciones:', data.subscriptions);
            });

            // Notificaci√≥n cuando un streamer suscrito inicia stream
            socket.on('stream:notification', (data) => {
                if (data.type === 'started') {
                    showStreamNotification(data);
                    console.log(`[Notificaci√≥n] ${data.streamerUsername} inici√≥ stream`);
                } else if (data.type === 'ended') {
                    showStreamEndedNotification(data);
                    console.log(`[Notificaci√≥n] ${data.streamerUsername} finaliz√≥ stream`);
                }
                
                // Actualizar lista de usuarios para reflejar el cambio de estado
                loadUsersList();
            });

            socket.on('disconnect', () => {
                console.log('Desconectado del servidor');
            });
        }

        function joinStream() {
            streamKey = document.getElementById('streamKeyInput').value.trim();
            if (!streamKey) {
                alert('Por favor ingresa una Stream Key');
                return;
            }
            socket.emit('stream:join', { streamKey });
        }

        async function handleOffer(data) {
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.ontrack = (event) => {
                console.log('üì° Recibiendo track:', event.track.kind, event.track.label);
                const videoElement = document.getElementById('remoteVideo');
                
                if (!videoElement.srcObject) {
                    videoElement.srcObject = event.streams[0];
                }
                
                // Verificar tracks de audio
                const audioTracks = event.streams[0].getAudioTracks();
                console.log('üîä Audio tracks recibidos:', audioTracks.length);
                audioTracks.forEach(track => {
                    console.log('  - Track:', track.label, 'enabled:', track.enabled);
                });
                
                // Intentar activar el audio autom√°ticamente
                videoElement.muted = false;
                videoElement.volume = 1.0;
                
                // Si falla el autoplay, pedir al usuario que haga click
                videoElement.play().catch(error => {
                    console.log('‚ö†Ô∏è Autoplay bloqueado, se requiere interacci√≥n del usuario');
                    // Mostrar un overlay para activar el audio
                    showAudioActivationOverlay(videoElement);
                });
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc:ice-candidate', {
                        type: 'ice-candidate',
                        data: event.candidate,
                        from: socket.id,
                        to: data.from,
                        streamKey
                    });
                }
            };

            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.data));
            
            const answer = await peerConnection.createAnswer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });
            await peerConnection.setLocalDescription(answer);

            console.log('‚úÖ Answer creado');

            socket.emit('webrtc:answer', {
                type: 'answer',
                data: answer,
                from: socket.id,
                to: data.from,
                streamKey
            });

            // Iniciar monitoreo de estad√≠sticas WebRTC
            startNetworkMonitoring();
        }

        /**
         * Monitoreo de estad√≠sticas WebRTC en tiempo real
         */
        function startNetworkMonitoring() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }

            console.log('üìä Iniciando monitoreo de red...');

            statsInterval = setInterval(async () => {
                if (!peerConnection) return;

                try {
                    const stats = await peerConnection.getStats();
                    processWebRTCStats(stats);
                } catch (error) {
                    console.error('Error obteniendo estad√≠sticas:', error);
                }
            }, 2000); // Cada 2 segundos
        }

        /**
         * Procesa las estad√≠sticas WebRTC
         */
        function processWebRTCStats(stats) {
            let packetsReceived = 0;
            let packetsLost = 0;
            let jitter = 0;
            let currentRoundTripTime = 0;
            let bytesReceived = 0;

            stats.forEach(report => {
                // Estad√≠sticas de video inbound
                if (report.type === 'inbound-rtp' && report.kind === 'video') {
                    packetsReceived = report.packetsReceived || 0;
                    packetsLost = report.packetsLost || 0;
                    jitter = report.jitter || 0;
                    bytesReceived = report.bytesReceived || 0;
                }

                // RTT (Round Trip Time) desde candidate-pair
                if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                    currentRoundTripTime = report.currentRoundTripTime || 0;
                }
            });

            // Calcular p√©rdida de paquetes
            const totalPackets = packetsReceived + packetsLost;
            const packetLossPercentage = totalPackets > 0 
                ? ((packetsLost / totalPackets) * 100).toFixed(2) 
                : 0;

            // Calcular latencia en ms
            const latencyMs = (currentRoundTripTime * 1000).toFixed(0);

            // Actualizar UI
            updateNetworkUI(packetLossPercentage, latencyMs, jitter);

            // Aplicar estrategias de buffering adaptativo
            applyAdaptiveBuffering(parseFloat(packetLossPercentage), packetsReceived);

            // Log peri√≥dico (cada 10 segundos aprox)
            if (Math.random() < 0.2) {
                console.log(`üìä Stats - P√©rdida: ${packetLossPercentage}% | Latencia: ${latencyMs}ms | Jitter: ${jitter}`);
            }
        }

        /**
         * Actualiza la UI con las estad√≠sticas de red
         */
        function updateNetworkUI(packetLoss, latency, jitter) {
            // Actualizar p√©rdida de paquetes
            document.getElementById('packetLoss').textContent = `${packetLoss}%`;

            // Actualizar latencia
            document.getElementById('latency').textContent = `${latency}ms`;

            // Determinar calidad de conexi√≥n
            const qualityIndicator = document.getElementById('connectionQuality').querySelector('.number');
            const loss = parseFloat(packetLoss);

            // Remover clases anteriores
            qualityIndicator.classList.remove('quality-excellent', 'quality-good', 'quality-fair', 'quality-poor');

            if (loss < 2) {
                qualityIndicator.textContent = 'üü¢';
                qualityIndicator.classList.add('quality-excellent');
            } else if (loss < 5) {
                qualityIndicator.textContent = 'üü°';
                qualityIndicator.classList.add('quality-good');
            } else if (loss < 10) {
                qualityIndicator.textContent = 'üü†';
                qualityIndicator.classList.add('quality-fair');
            } else {
                qualityIndicator.textContent = 'üî¥';
                qualityIndicator.classList.add('quality-poor');
            }
        }

        /**
         * Aplica estrategias de buffering adaptativo seg√∫n condiciones de red
         */
        function applyAdaptiveBuffering(packetLoss, packetsReceived) {
            const videoElement = document.getElementById('remoteVideo');
            const bufferingOverlay = document.getElementById('bufferingOverlay');
            const poorConnectionWarning = document.getElementById('poorConnectionWarning');

            // Estrategia 1: Buffering autom√°tico en caso de alta p√©rdida de paquetes
            if (packetLoss > 15 && !bufferingActive) {
                console.warn('‚ö†Ô∏è Alta p√©rdida de paquetes, activando buffering...');
                bufferingOverlay.classList.remove('hidden');
                bufferingActive = true;
                
                // Pausar video brevemente para acumular buffer
                if (!videoElement.paused) {
                    videoElement.pause();
                    setTimeout(() => {
                        videoElement.play();
                        bufferingOverlay.classList.add('hidden');
                        bufferingActive = false;
                    }, 2000); // 2 segundos de buffering
                }
            }

            // Estrategia 2: Advertencia de conexi√≥n pobre
            if (packetLoss > 10) {
                consecutivePoorQuality++;
                if (consecutivePoorQuality > 3) { // 3 mediciones consecutivas (6 segundos)
                    poorConnectionWarning.classList.remove('hidden');
                }
            } else if (packetLoss < 5) {
                consecutivePoorQuality = 0;
                poorConnectionWarning.classList.add('hidden');
            }

            // Estrategia 3: Ajustar preload del video seg√∫n calidad
            if (packetLoss > 8) {
                videoElement.preload = 'auto'; // Precargar m√°s datos
            } else {
                videoElement.preload = 'metadata'; // Modo normal
            }

            // Estrategia 4: Detectar si el stream se detuvo (no llegan paquetes)
            const packetsDiff = packetsReceived - lastPacketsReceived;
            if (packetsDiff === 0 && packetsReceived > 0) {
                console.warn('‚ö†Ô∏è No se est√°n recibiendo paquetes nuevos');
                bufferingOverlay.classList.remove('hidden');
            } else if (packetsDiff > 0 && bufferingActive) {
                bufferingOverlay.classList.add('hidden');
                bufferingActive = false;
            }

            lastPacketsReceived = packetsReceived;
        }

        /**
         * Detiene el monitoreo de red
         */
        function stopNetworkMonitoring() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
                console.log('üìä Monitoreo de red detenido');
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message && streamKey) {
                socket.emit('chat:message:send', { streamKey, content: message });
                input.value = '';
            }
        }

        function sendReaction(emoji) {
            if (streamKey) {
                socket.emit('reaction:send', { streamKey, emoji });
            }
        }

        function addChatMessage(msg) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'chat-message' + (msg.type === 'SYSTEM' ? ' system' : '');
            div.innerHTML = `<strong>${msg.username}:</strong> ${msg.content}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showReaction(reaction) {
            addChatMessage({ 
                username: reaction.username, 
                content: reaction.emoji + ' reaccion√≥', 
                type: 'SYSTEM' 
            });
        }

        function leaveStream() {
            // Detener monitoreo de red
            stopNetworkMonitoring();
            
            // Notify server that viewer is leaving the stream
            if (streamKey) {
                socket.emit('stream:leave', { streamKey: streamKey });
            }
            
            if (peerConnection) {
                peerConnection.close();
            }
            location.reload();
        }

        function showAudioActivationOverlay(videoElement) {
            // Crear overlay si no existe
            let overlay = document.getElementById('audioOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'audioOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    cursor: pointer;
                `;
                overlay.innerHTML = `
                    <div style="text-align: center; color: #ffa500;">
                        <h2 style="font-size: 48px; margin-bottom: 20px;">üîä</h2>
                        <h2 style="color: #ff8c00;">Haz click para activar el audio</h2>
                        <p style="color: #9370db; margin-top: 10px;">El navegador requiere interacci√≥n del usuario</p>
                    </div>
                `;
                overlay.onclick = () => {
                    videoElement.muted = false;
                    videoElement.play().then(() => {
                        overlay.remove();
                        console.log('Audio activado correctamente');
                    }).catch(err => {
                        console.error('Error al activar audio:', err);
                    });
                };
                document.body.appendChild(overlay);
            }
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Funciones de suscripciones
        function loadUsersList() {
            socket.emit('users:get');
        }

        function loadSubscribedStreams() {
            socket.emit('subscriptions:get');
        }

        function renderUsersList() {
            const container = document.getElementById('usersList');
            
            // Efecto visual de actualizaci√≥n
            container.style.opacity = '0.5';
            setTimeout(() => {
                container.style.transition = 'opacity 0.3s ease';
                container.style.opacity = '1';
            }, 100);
            
            if (allUsers.length === 0) {
                container.innerHTML = '<p style="color: #9370db;">No hay otros usuarios conectados</p>';
                return;
            }

            container.innerHTML = allUsers.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-name">${user.username}</div>
                        <div class="user-status">
                            ${user.role === 'STREAMER' ? 'üìπ Streamer' : 'üë§ Viewer'}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button 
                            class="btn-subscribe ${user.isSubscribed ? 'subscribed' : ''}"
                            onclick="toggleSubscription('${user.userId}', ${user.isSubscribed})">
                            ${user.isSubscribed ? '‚úì Suscrito' : '+ Suscribirse'}
                        </button>
                    </div>
                </div>
            `).join('');
            
            console.log(`[Lista Usuarios] ${allUsers.length} usuario(s) renderizados`);
        }

        function updateSubscribedStreams() {
            const subscribedUsers = allUsers.filter(u => u.isSubscribed && u.streamStatus === 'active');
            const container = document.getElementById('subscribedStreams');
            
            // Efecto visual de actualizaci√≥n
            container.style.opacity = '0.5';
            setTimeout(() => {
                container.style.transition = 'opacity 0.3s ease';
                container.style.opacity = '1';
            }, 100);
            
            if (subscribedUsers.length === 0) {
                container.innerHTML = '<p style="color: #9370db;">No hay streams activos de usuarios a los que est√°s suscrito</p>';
                return;
            }

            container.innerHTML = subscribedUsers.map(user => `
                <div class="stream-card" onclick="joinStreamByKey('${user.currentStreamKey}')">
                    <h4>
                        <span class="live-indicator">üî¥ EN VIVO</span>
                        ${user.username}
                    </h4>
                    <p style="color: #9370db;">Click para unirte al stream</p>
                </div>
            `).join('');
            
            console.log(`[Streams Activos] ${subscribedUsers.length} stream(s) de suscripciones`);
        }

        function toggleSubscription(targetUserId, isCurrentlySubscribed) {
            if (isCurrentlySubscribed) {
                socket.emit('user:unsubscribe', { targetUserId });
            } else {
                socket.emit('user:subscribe', { targetUserId });
            }
        }

        function joinStreamByKey(key) {
            document.getElementById('streamKeyInput').value = key;
            joinStream();
        }

        function showStreamNotification(data) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <h4>üî¥ ${data.streamerUsername} est√° en vivo!</h4>
                <p>Un streamer al que est√°s suscrito ha iniciado un stream</p>
                <small style="color: #9370db; display: block; margin-top: 8px;">
                    ‚ú® La lista de streams activos se ha actualizado autom√°ticamente
                </small>
                <div class="notification-actions">
                    <button class="btn-primary" onclick="joinStreamByKey('${data.streamKey}'); this.parentElement.parentElement.remove();">
                        Ver Ahora
                    </button>
                    <button class="btn-info" onclick="this.parentElement.parentElement.remove();">
                        M√°s tarde
                    </button>
                </div>
            `;
            document.body.appendChild(notification);

            // Auto-remover despu√©s de 10 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function showStreamEndedNotification(data) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderColor = '#9370db';
            notification.innerHTML = `
                <h4>‚èπÔ∏è ${data.streamerUsername} finaliz√≥ su stream</h4>
                <p>El stream al que estabas suscrito ha terminado</p>
                <small style="color: #9370db; display: block; margin-top: 8px;">
                    ‚ú® La lista de streams activos se ha actualizado autom√°ticamente
                </small>
                <div class="notification-actions">
                    <button class="btn-info" onclick="this.parentElement.parentElement.remove();">
                        Entendido
                    </button>
                </div>
            `;
            document.body.appendChild(notification);

            // Auto-remover despu√©s de 8 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 8000);
        }

        function clearSavedUser() {
            sessionStorage.removeItem('streamhub_username');
            document.getElementById('usernameInput').value = '';
            document.getElementById('usernameInput').placeholder = 'Tu nombre de usuario';
            console.log(`[Tab ${tabId}] Usuario de esta pesta√±a eliminado`);
            alert('Usuario de esta pesta√±a eliminado. Puedes ingresar uno nuevo.');
        }
    </script>
</body>
</html>
